name: Accessibility Test
on: [push]

jobs:
  accessibility:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker
        uses: docker/setup-buildx-action@v2
        
      - name: Install Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose

      - name: Build and run Docker Compose
        env:
          DATABASE_PASSWORD: ${{ secrets.DATABASE_PASSWORD }}
        run: |
          docker-compose -f docker-compose.dev.yml up -d  
          
          # Wait for DB services to be ready (adjust sleep time as necessary)
          echo "Waiting for database to be ready..."
          sleep 30

      - name: Install dependencies
        run: npm install

      - name: Build Next.js application
        run: npm run build

      - name: Start Next.js application
        env:
          DATABASE_URL: postgres://postgres:${{ secrets.DATABASE_PASSWORD }}@localhost:5433/patrigma_db
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXT_PUBLIC_API_BASE_URL: http://localhost:3000
        run: |
          npm run start &  # Start the Next.js application in the background
          echo "Waiting for Next.js to be ready..."
          sleep 10  # Adjust this depending on how long your app takes to start

      - name: Install xvfb
        run: sudo apt-get install -y xvfb

      - name: Install Lighthouse
        run: npm install -g lighthouse

      - name: Run Lighthouse Accessibility Tests
        run: |
          xvfb-run lighthouse http://localhost:3000 --output json --output-path ./lighthouse-report.json --only-categories=accessibility
          xvfb-run lighthouse http://localhost:3000 --output html --output-path ./lighthouse-report.html --only-categories=accessibility

      - name: Upload Lighthouse Report JSON
        uses: actions/upload-artifact@v3
        with:
          name: lighthouse-report-json
          path: ./lighthouse-report.json

      - name: Upload Lighthouse Report HTML
        uses: actions/upload-artifact@v3
        with:
          name: lighthouse-report-html
          path: ./lighthouse-report.html

      - name: Extract Accessibility Score
        run: |
          node -e "
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('./lighthouse-report.json', 'utf8'));
            const score = report.categories.accessibility.score * 100;
            console.log('Accessibility Score:', score);
            if (score < 90) {
              process.exit(1);
            }
          "
